# 三模型协作系统 - 指挥官架构 v3.0

> 参考 [ccg-workflow](https://github.com/fengshao1227/ccg-workflow) 设计理念

## 核心原则

### 1. 角色分工

```
┌─────────────────────────────────────────────────────────────┐
│                    OpenClaw (指挥官/编排者)                   │
│  - 任务规划与分解 (WBS)                                       │
│  - 代码审核与合并                                             │
│  - 质量把关与验收                                             │
│  - 全局协调与决策                                             │
├─────────────────────────────────────────────────────────────┤
│         Claude CLI              │         Gemini CLI         │
│    (后端/逻辑/算法权威)          │    (前端/UI/设计权威)        │
│  - 复杂重构                      │  - 架构设计                 │
│  - i18n 迁移                     │  - UI 组件                  │
│  - 代码审查                      │  - 新功能开发               │
├─────────────────────────────────────────────────────────────┤
│                         Codex CLI                            │
│                    (修复/测试/清理权威)                        │
│  - Bug 修复                                                  │
│  - 测试编写                                                  │
│  - 代码清理                                                  │
│  - 性能优化                                                  │
└─────────────────────────────────────────────────────────────┘
```

### 2. 信任规则

| 领域 | 权威模型 | 说明 |
|------|----------|------|
| 后端逻辑 | Claude | 算法、数据流、错误处理 |
| 前端设计 | Gemini | UI/UX、视觉、交互 |
| 修复测试 | Codex | Bug 修复、测试、清理 |
| 最终决策 | OpenClaw | 审核、合并、验收 |

### 3. 零写入权限

**外部模型 (Claude/Gemini/Codex CLI) 不能直接修改代码**

工作流：
1. Agent 输出代码建议/Patch
2. OpenClaw 审核
3. 审核通过 → OpenClaw 执行修改
4. 审核失败 → 返回修改意见

## 工作流设计

### 6 阶段工作流

```
┌─────────┐    ┌─────────┐    ┌─────────┐
│ 1.研究  │ → │ 2.构思  │ → │ 3.计划  │
│ Research│    │ Ideate  │    │  Plan   │
└─────────┘    └─────────┘    └─────────┘
     ↓              ↓              ↓
  需求分析      方案对比       WBS分解
  上下文检索    多模型分析     任务清单
  完整性评分    交叉验证       依赖关系
     
┌─────────┐    ┌─────────┐    ┌─────────┐
│ 4.执行  │ → │ 5.优化  │ → │ 6.评审  │
│ Execute │    │ Optimize│    │ Review  │
└─────────┘    └─────────┘    └─────────┘
     ↓              ↓              ↓
  代码实现      代码审查       质量验收
  里程碑检查    性能优化       测试验证
  进度追踪      安全检查       最终确认
```

### 规划与执行分离

**规划阶段** (不修改代码):
1. 需求分析
2. 上下文检索
3. 多模型并行分析
4. 生成 WBS 任务清单
5. 保存计划到 `.claude/plan/`

**执行阶段** (按计划执行):
1. 读取计划文件
2. 按步骤执行
3. 每步验证
4. 失败则回滚

## 任务分解 (WBS)

### 分解层级

```
Level 1: 功能 (Feature)
    ↓
Level 2: 模块 (Module)
    ↓
Level 3: 文件 (File)
    ↓
Level 4: 任务 (Task)
```

### 任务模板

```markdown
## 任务: <任务名>

**类型**: 前端/后端/全栈
**分配**: Claude/Gemini/Codex
**预估**: X 任务点 (1点 ≈ 1-2小时)

### 输入
- <依赖的数据/前置任务>

### 输出
- <产出的结果>

### 步骤
1. <具体步骤>
2. <具体步骤>

### 验收标准
- [ ] <标准1>
- [ ] <标准2>
```

## 质量把关

### 评分机制

每个阶段完成后评分 (0-10):

| 维度 | 分值 | 说明 |
|------|------|------|
| 目标明确性 | 0-3 | 需求是否清晰 |
| 预期结果 | 0-3 | 产出是否明确 |
| 边界范围 | 0-2 | 范围是否界定 |
| 约束条件 | 0-2 | 限制是否明确 |

**止损规则**:
- ≥7 分: 继续下一阶段
- <7 分: 停止，补充信息

### 代码审查

```markdown
## 审查报告

### Critical (必须修复)
- <问题描述>

### Major (应该修复)
- <问题描述>

### Minor (建议修复)
- <问题描述>

### 总体评价
- 代码质量: [优秀/良好/需改进]
- 是否可合并: [是/否/需修复后]
```

## Redis 状态管理

### 任务状态

```
openclaw:task:{id}:status     # pending/planning/executing/reviewing/done/failed
openclaw:task:{id}:plan       # 计划内容 (JSON)
openclaw:task:{id}:progress   # 当前进度 (步骤号)
openclaw:task:{id}:agent      # 分配的 agent
openclaw:task:{id}:score      # 质量评分
```

### 工作流状态

```
openclaw:workflow:current     # 当前工作流 ID
openclaw:workflow:{id}:phase  # 当前阶段 (1-6)
openclaw:workflow:{id}:tasks  # 任务列表
```

## 指挥官职责

### 核心职责

1. **需求分析**: 理解用户需求，评估完整性
2. **任务分解**: 使用 WBS 分解为可执行任务
3. **智能分配**: 根据任务类型分配给合适的 agent
4. **进度追踪**: 监控执行进度，处理阻塞
5. **质量把关**: 审核代码，验收结果
6. **协调冲突**: 处理多 agent 冲突

### 决策规则

1. **任务分配**:
   - 后端逻辑/重构/i18n → Claude
   - 前端/UI/架构设计 → Gemini
   - Bug修复/测试/清理 → Codex

2. **冲突处理**:
   - 同一文件 → 暂停后来者，协调分工
   - 意见分歧 → 按信任规则裁决

3. **失败处理**:
   - 单次失败 → 分析原因，重试
   - 多次失败 → 升级给用户

## 与现有系统集成

### 定时任务角色

| 任务 | 角色 | 职责 |
|------|------|------|
| 🔄 流水线 | 工作流引擎 | 驱动 6 阶段流程 |
| 🎯 指挥官 | 战略规划 | WBS 分解，任务分配 |
| 👁️ 状态感知 | 监控 | 检测状态变化 |
| 🔍 代码审查 | 质量把关 | 审核代码质量 |
| ✅ 任务验收 | 验收 | 验证完成标准 |

### 事件流

```
用户需求 → 指挥官(WBS分解) → 任务队列
                ↓
        流水线(分配执行)
                ↓
    Agent完成 → 状态感知(检测) → 事件队列
                ↓
        流水线(触发审查)
                ↓
    代码审查 → 通过? → 是 → 流水线(触发测试)
                ↓ 否          ↓
           返回修改      测试通过? → 是 → 流水线(提交)
                              ↓ 否
                         返回修复
```
