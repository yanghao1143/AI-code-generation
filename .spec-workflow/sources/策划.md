# 星缘粉丝命理管理系统 - 产品需求文档 (PRD)

## 1. 产品概述

### 1.1 产品定位与愿景
* **产品定位:** 主播专用的粉丝互动与命理服务平台，集成实时对话与多维度命理测算功能
* **产品愿景:** 成为主播与粉丝建立深度情感连接的首选命理互动工具
* **核心价值:** 帮助主播通过个性化命理服务增强粉丝粘性，提升互动质量与变现能力

### 1.2 目标用户
* **核心用户:** 命理、情感、生活类主播（个人主播/机构主播）
* **终端用户:** 主播的粉丝群体（18-45岁，对命理、星座、个人运势感兴趣的用户）

## 2. 核心功能模块

### 2.1 粉丝互动管理 (FIM-001)
* **实时流式对话系统** (FIM-001-01)
  - 支持文字、语音、表情混合聊天
  - 消息已读状态显示
  - 快捷回复模板功能
  - AI智能高情商回复 (FIM-001-05)
    - 主播输入后自动生成3-5个高情商回复选项
    - 支持查看历史对话上下文，保持对话连贯性
    - 回复内容记录至数据库，形成个性化回复库
    - 一键发送功能，支持直接选用推荐回复
    - 回复效果跟踪，统计被采纳率和粉丝反馈
  - 对话超时提醒机制

* **粉丝标签体系** (FIM-001-02)
  - 自动标签：基于互动频率、消费能力、兴趣偏好
  - 手动标签：支持主播自定义粉丝标签
  - 标签组合筛选功能

### 2.2 命理测算服务 (FMS-002)

| 服务ID | 服务名称 | 核心功能 | 数据输入项 |
|--------|----------|----------|------------|
| FMS-002-01 | 星座运势测算 | 每日/周/月/年运势分析 | 出生日期、星座 |
| FMS-002-02 | 周易命理分析 | 生辰八字解析、五行命理 | 出生年月日时、性别 |
| FMS-002-03 | 八卦占卜服务 | 事业/健康/财运卦象解读 | 求卦问题、性别 |
| FMS-002-04 | 未来运势预测 | 短期/中期/长期运势趋势 | 出生日期、关注领域 |
| FMS-002-05 | 过去命理回溯 | 人生关键节点命理分析 | 出生日期、年龄 |
| FMS-002-06 | 婚姻感情测算 | 姻缘分析、感情走势 | 双方出生日期、性别 |
| FMS-002-07 | 财富运势评估 | 财运走向、投资建议 | 出生日期、职业类型 |

### 2.3 命理资料管理 (FMM-003)
* **粉丝命理档案** (FMM-003-01)
  - 自动存储粉丝提供的个人信息（生日、性别、出生地等）
  - 历史测算记录查询
  - 个人运势变化趋势图表

* **测算模板管理** (FMM-003-02)
  - 内置标准化测算模板
  - 支持主播自定义测算问题与流程
  - 测算结果话术个性化设置

### 2.4 主播工作台 (AW-004)
* **数据统计分析** (AW-004-01)
  - 粉丝增长趋势图
  - 互动活跃度分析
  - 测算服务使用排行
  - 粉丝留存率报表

* **内容管理工具** (AW-004-02)
  - 测算结果分享素材生成
  - 直播预告与提醒设置
  - 粉丝互动话术库

### 2.5 直播内容管理 (LCM-005)
* **话题系统** (LCM-005-01)
  - 热门话题库与分类标签
  - 话题热度趋势分析
  - 自定义话题创建与管理
  - 话题关联测算服务推荐
  - 推荐服务一键添加至直播脚本
  - 话题效果实时监测与数据反馈
  - 基于互动数据自动优化话题推荐
* **直播脚本制作** (LCM-005-02)
  - 多场景脚本模板库
  - 拖拽式脚本编辑工具
  - 关键节点时间标记
  - 脚本内容与测算服务联动

* **直播脚本库** (LCM-005-02.1)
  - NLP智能脚本生成：基于自然语言输入自动生成完整直播脚本
  - 直播流程自动化生成：根据主题和时长智能规划环节与时间分配
  - 智能内容策划：结合热点话题与粉丝兴趣自动推荐直播内容
  - 脚本模板管理：支持自定义模板创建与复用
  - 内容个性化调整：根据主播风格自动优化语言表达
  - 历史脚本查询与复用：按主题、日期、效果等多维度检索

* **直播流程管理** (LCM-005-03)
  - 可视化直播流程图设计
  - 流程节点任务分配
  - 直播环节时长预估
  - 流程执行进度追踪

* **智能内容策划** (LCM-005-04)
  - 基于粉丝画像的内容推荐
  - 实时内容效果反馈调整
  - 粉丝数据库自动匹配最佳方案
  - 内容更新历史版本管理
### 2.6 智能工作流引擎 (IWE-006)

* **自然语言工作流生成器** (IWE-006-01)
  - 自然语言解析引擎：将主播输入的自然语言描述转化为结构化工作流
  - 智能体自动配置：根据需求描述自动生成AI智能体参数与响应规则
  - 工作流程推荐：基于行业最佳实践提供流程模板建议
  - 多场景适配：支持直播互动、粉丝服务、内容生产等多场景工作流生成
  - 自然语言指令调试：通过对话方式修改和完善工作流逻辑
  - 智能错误检测：自动识别流程逻辑冲突并提供优化建议

* **可视化工作流编辑器** (IWE-006-02)
  - 拖拽式流程图界面：直观调整工作流节点与连接关系
  - 节点属性配置面板：自定义每个流程节点的参数与行为
  - 工作流模板库：内置常用场景模板，支持一键复用
  - 版本管理系统：保存工作流历史版本，支持对比与回滚
  - 实时运行预览：编辑时实时查看工作流执行效果
  - 权限管理：支持多角色协作编辑与审批流程

* **智能体管理中心** (IWE-006-03)
  - AI智能体市场：提供多种预设功能的智能体类型
  - 自定义智能体创建：通过自然语言描述生成专属智能体
  - 智能体技能配置：为智能体添加命理测算、情感分析等专业技能
  - 智能体训练面板：基于历史交互数据优化智能体响应质量
  - 多智能体协作编排：设计多个智能体协同工作的流程逻辑

* **工作流运行监控** (IWE-006-04)
  - 实时执行状态追踪：可视化监控工作流运行情况
  - 性能指标分析：执行效率、成功率、用户反馈等数据统计
  - 异常告警机制：自动识别异常流程并通知管理员
  - 数据导出与报告：生成工作流效果分析报告
  - 自动优化建议：基于运行数据提供流程改进建议

* **与直播脚本系统联动** (IWE-006-05)
  - 工作流嵌入直播脚本：将自动化流程与直播环节无缝集成
  - 实时触发机制：基于直播进度自动启动相应工作流
  - 智能体直播互动：工作流控制智能体参与直播互动
  - 粉丝行为触发：根据粉丝操作自动执行预设工作流

## 3. 用户界面设计

### 3.1 主播端核心页面
1. **工作台首页** - 数据概览与快捷功能入口
2. **粉丝聊天列表页** - 所有粉丝对话集中管理
3. **对话详情页** - 实时聊天与测算功能集成界面
4. **粉丝管理页** - 粉丝资料与标签管理
5. **粉丝命理详情页** - 展示粉丝详细命理信息，包括年龄、星座、周易命理分析、婚姻状况、子女情况、未来财富趋势、当日/当月运势及流年大事件提醒
6. **测算服务配置页** - 自定义测算参数与模板
7. **数据分析页** - 多维度数据报表展示
8. **话题管理页** - 话题创建、分类与热度分析
9. **直播脚本编辑页** - 脚本制作与内容编排
10. **直播流程设计页** - 可视化直播流程规划
11. **内容策划工作台** - 智能内容推荐与方案生成
### 3.2 粉丝端核心页面
1. **主播主页** - 主播资料与服务介绍
2. **聊天互动页** - 与主播实时对话界面
3. **测算请求页** - 提交个人信息与测算需求
4. **测算结果页** - 命理分析结果展示
5. **个人中心** - 历史测算记录与个人资料

## 4. 技术架构概述

### 4.1 系统架构
* 前端：React Native (移动端)、React (Web端)
* 后端：Golang + Gin（REST）+ WebSocket网关
* 数据库：MySQL (用户数据) + MongoDB (聊天记录)
* 向量数据库：Qdrant/Milvus 
* 实时通讯：WebSocket协议
* 部署环境：云服务器集群 + CDN加速

### 4.2 核心技术难点
* 高并发实时对话系统的稳定性保障
* 命理测算算法的准确性与可扩展性
* 大量用户数据的安全存储与快速查询

### 4.3 Golang后端系统架构方案

#### 4.3.1 后端架构
- 模块化开发（分层）：
  - 领域层（Domain/Core）：领域模型与业务接口（如 UserService、FortuneService、WorkflowService）
  - 接口层（API）：HTTP Handler，仅负责入参校验、调用接口、出参封装
  - 基础设施层（Infra）：仓储实现（MySQL/Mongo/Redis）、消息、缓存、日志
  - 中间件层（Middleware）：鉴权、限流、审计、CORS、错误码与统一返回
- 统一的 API 路由管理中心：
  - 路由集中注册与分组（如 /api/v1 下按模块 FIM/FMS/IWE 分组）
  - 每条路由绑定元数据（method、path、summary、tags、requiredPermissions、requestSchema、responseSchema）
  - 自动维护 API 注册表（Registry），对外暴露 `/api/registry` 供前端自动读取与展示
  - 支持版本化与多环境灰度（v1/v2 并存）
- 抽象接口管理机制：
  - 所有业务通过接口定义，Handler 仅依赖接口；实现通过依赖注入（DI）切换
  - 仓储与外部网关同样抽象（如 UserRepo、ChatRepo、PaymentGateway），便于测试与替换
- 目录结构建议：
  - `backend/cmd/server`：服务入口（加载配置、DI、启动路由与中间件）
  - `backend/internal/router`：路由管理中心（注册、分组、权限绑定、暴露 Registry）
  - `backend/internal/registry`：API 注册表（元数据维护、JSON 输出）
  - `backend/internal/api`：各模块 Handler（FIM/FMS/IWE/AW/LCM）
  - `backend/internal/core`：领域接口与模型（User/FanProfile/FortuneRecord/Workflow 等）
  - `backend/internal/infra`：仓储实现（MySQL/Mongo/Redis/消息队列）
  - `backend/internal/middleware`：鉴权、限流、审计、CORS、统一错误处理
  - `backend/internal/docs`：OpenAPI/Swagger 生成文件
  - `backend/config`：多环境配置（dev/staging/prod）
- 数据与缓存：
  - MySQL：用户、订单、权限策略等结构化数据
  - MongoDB：聊天消息、脚本、工作流运行日志等
  - Redis：会话、权限缓存、热点数据、限流计数器
- 实时通讯：
  - WebSocket 网关，支持身份校验、房间管理、消息路由、离线队列
- API 文档：
  - 通过注解生成 OpenAPI（Swagger），与 `/api/registry` 元数据保持一致性

#### 4.3.2 前端架构（管理后台与移动端）
- 路由管理系统：
  - 统一 `route-config`，按模块与权限动态渲染菜单与页面
  - 支持多角色（主播、管理员、运营）不同可见性策略
- 可视化管理后台（React）：
  - API 目录页：按 tags/模块/版本检索接口，查看权限与示例
  - API 详情页：展示文档、请求/响应 schema、在线调试
  - 权限管理页：角色、策略、接口权限映射与审计日志
  - 配置页：环境切换、开关、限流阈值
- API 自动注册与展示：
  - 启动时请求 `/api/registry`，自动生成 API 列表与文档视图
  - 根据 `requestSchema` 自动生成动态表单，实现“新 API 的自动填充”
  - 根据 `responseSchema` 自动渲染结果视图与校验
- 移动端（React Native）：
  - 共享统一 API 客户端与权限策略，按端特性简化交互

#### 4.3.3 系统要求与规范
- 前后端分离：后端只提供 API 与 WebSocket；前端管理后台与移动端独立部署
- 模块化开发规范：严格分层、接口抽象、依赖注入，避免跨层耦合
- 统一权限管理系统：
  - 认证：JWT + Refresh Token，敏感操作二次验证
  - 授权：RBAC（角色→策略→动作），路由注册时声明 `requiredPermissions`
  - 审计：敏感接口访问与配置变更写入审计日志，支持追踪
- API 文档自动生成：
  - CI 在构建后生成 `swagger.json` 与 `/api/registry` 快照，供前端展示与对比
- 版本化与灰度：多版本共存，按用户或环境进行灰度发布与回滚
- 安全与合规：TLS、WAF、速率限制、数据加密、隐私合规（参照 7.3 要求）

#### 4.3.4 关键接口与示例
- 路由示例：
  - `POST /api/v1/users`（users:create）
  - `POST /api/v1/fortune/zodiac`（fortune:calc）
  - `GET /api/registry`（公开接口，提供所有路由元数据）
- `/api/registry` 返回数据示例（简化）：
  - `[{ "method": "POST", "path": "/api/v1/users", "summary": "创建用户", "tags": ["users"], "requiredPermissions": ["users:create"], "requestSchema": {"name": "string"}, "responseSchema": {"id": "string", "name": "string"} }]`

#### 4.3.5 部署与运维
- 多环境：dev/staging/prod，配置中心管理敏感参数（DB、JWT 密钥）
- 观测性：结构化日志、指标（QPS/错误率/P99）、分布式追踪、告警
- 灰度与回滚：按版本与路由分组灰度，支持快速回滚与兼容策略
- 安全加固：输入校验、统一错误码、异常保护、限流与隔离

### 4.4 向量数据库与机器学习架构方案

#### 4.4.1 设计目标
- 高效存储与检索多模态向量（文本/语音/图片/结构化特征）
- 提供在线/离线机器学习能力（分析、预测、推荐、异常检测）
- 满足高并发与低延迟（P99 ≤ 100ms，百万级向量规模可水平扩展）
- 与现有模块（FIM/FMS/IWE/AW/LCM）解耦集成，面向接口扩展

#### 4.4.2 架构组件
- Embedding 服务（Go + gRPC）：统一向量化接口，支持多模型（句向量、声学、图像）
- Vector Store（Qdrant/Milvus/pgvector）：提供ANN检索、过滤与分区管理
- Feature Store（Redis/MySQL）：在线特征缓存与离线特征快照（用于模型推理/训练）
- ML 服务（Go 服务 + Python 侧车可选）：推理/训练双栈，Go 暴露 API，Python 执行重计算
- 流式管道（Kafka）：实时数据摄取、增量向量更新与事件驱动
- 任务编排（Scheduler）：离线批处理（重建索引、训练、评估、导出）
- 监控与审计：指标（QPS、召回率、延迟）、模型版本与效果追踪、审计日志

#### 4.4.3 数据与索引设计
- 向量维度：依模型配置（如 384/768/1024），在 Registry 记录维度与模型ID
- 元数据（payload）：`userId、fanId、type、module、createdAt、tags、language、region`
- 分区与集合：按模块/业务场景分集合（如 `vectors_fim_chat`、`vectors_fms_fortune`）
- 索引类型：
  - HNSW（高召回、低延迟，适中规模）
  - IVF/IVF-PQ（大规模、磁盘友好，离线批量构建）
  - 混合检索（ANN + 关键词BM25/过滤条件）
- 过滤与排序：基于标签/时间窗口/地理/权限进行过滤；支持重排（rerank）

#### 4.4.4 向量检索与智能分析
- 基础检索：kNN、范围检索、相似度阈值检索（cosine/L2/dot）
- 混合检索：关键词 + 向量融合，提升可解释性（如聊天召回 + 语义相似）
- 智能分析：
  - 粉丝画像聚类（KMeans/HDBSCAN/UMAP 可视化）
  - 内容相似度与去重，热点话题发现
  - 会话意图识别与自动回复候选生成（结合 IWE 工作流）

#### 4.4.5 机器学习能力
- 任务类型：
  - 分类/多标签：粉丝类别、内容类型识别
  - 回归/预测：活跃度、留存、付费概率、流量趋势（时序模型）
  - 排序/推荐：内容/脚本/测算服务推荐（Learning-to-rank）
  - 异常检测：敏感行为、异常互动、数据质量监控
- 模型管理：
  - 版本化与灰度（A/B 测试、在线效果对比）
  - 在线推理（低延迟 gRPC/HTTP）、离线训练（批处理/增量）
  - 特征治理：线上/离线特征一致性、特征字典与血缘

#### 4.4.6 可扩展性与高性能设计
- 水平扩展：向量库分片与副本；Embedding/ML 服务无状态伸缩
- 热数据策略：短期热门向量驻留内存；冷数据移至低成本存储
- 批量与流式：批量导入（bulk upsert）、流式增量（实时更新索引）
- 缓存与并发：结果缓存、向量分桶、连接池、批量RPC
- 性能指标：
  - 写入吞吐：≥ 10k upserts/min（可扩展）
  - 检索延迟：P50 ≤ 30ms，P99 ≤ 100ms（小批量查询）
  - 召回率目标：≥ 0.9（与任务相关）

#### 4.4.7 核心 API（与统一路由中心对齐）
- 向量写入：`POST /api/v1/vectors/upsert`（批量，含向量与payload）
- 向量检索：`POST /api/v1/vectors/search`（kNN/过滤/混合）
- 数据集管理：`POST /api/v1/datasets`、`GET /api/v1/datasets/:id`
- 嵌入生成：`POST /api/v1/embeddings`（文本/语音/图片）
- 模型推理：`POST /api/v1/ml/predict`（分类/回归/排序）
- 模型管理：`POST /api/v1/ml/models`、`GET /api/v1/ml/models/:id`
- 评估与监控：`GET /api/v1/ml/metrics`、`GET /api/v1/vectors/stats`

#### 4.4.8 典型流程
1) 数据摄取：聊天消息/脚本/粉丝资料 → 清洗与标注 → Embedding → Upsert 至 Vector Store
2) 在线检索：查询文本 → Embedding → ANN 检索 → 过滤/重排 → 返回候选与解释
3) 智能预测：聚合用户特征 → `ml/predict` 推理 → 推荐服务或内容
4) 离线训练：抽样数据 → 训练/评估 → 上线新模型 → 灰度并追踪指标

#### 4.4.9 运维与合规
- 观测：端到端指标与追踪；模型/索引版本可视化
- 审计：模型变更、数据访问记录；敏感数据脱敏与最小化收集
- 合规：遵循 7.3 隐私要求；支持数据删除权与去标识化处理

### 4.5 国内大模型API集成方案

#### 4.5.1 目标与原则
- 统一接口：为所有厂商提供一致的 Chat/Embed/Moderate/Stream 能力抽象，屏蔽差异。
- 可插拔适配：采用适配器模式接入不同厂商，按需启用与扩容。
- 合规与安全：密钥管理、最小化数据、内容合规审查、区域与网络合规。
- 高可用与成本控制：熔断/降级、故障切换、按SLA与单次成本做智能路由。
- 可观测与评估：质量评估、延迟与成功率监控、A/B测试与效果对比。

#### 4.5.2 厂商与模型（示例，按可用性配置）
- 百度文心（ERNIE）
- 阿里通义千问（Qwen）
- 腾讯混元（Hunyuan）
- 讯飞星火（Spark）
- 字节豆包（Doubao）
- 智谱GLM（GLM）
- MiniMax、华为相关服务、京东言犀等（按需扩展）

#### 4.5.3 统一接口与适配器设计（Golang）
- 接口：
  - `LLMClient`：`Chat(ctx, req) (resp, error)`、`ChatStream(ctx, req) (<-chan Token, error)`、`Embed(ctx, req)`、`Moderate(ctx, req)`。
  - `ProviderAdapter`：封装签名、鉴权、重试、错误码映射、限流。
- 元数据：在 `Registry` 记录 `providerId、modelId、capabilities（text/image/audio）、limits（tokens/qps）、cost`。
- 流式：统一SSE/WebSocket推送，前端可直接复用聊天流式组件。
- Prompt与模板：集中管理系统提示与模板版本，支持多厂商差异化参数映射。

#### 4.5.4 路由策略与故障切换
- 基于策略的选择：优先级、加权与健康度，结合实时延迟与成功率。
- 能力匹配：按 `capabilities` 与合规需求（如内容审查）匹配可用厂商。
- 熔断与降级：单厂商故障时自动切换；超时降级至摘要/离线结果或提示。
- 成本与配额：控制高成本模型调用比例，配额用尽自动切换至备选模型。

#### 4.5.5 安全与合规
- 密钥与凭据：集中加密存储（Key Vault），最小权限访问与定期轮换。
- 数据最小化：仅发送必要上下文，敏感信息脱敏，支持匿名与去标识化。
- 内容合规：调用前后内置敏感内容检测；保留审计日志与拦截记录。
- 区域与网络：按区域路由与CDN优化，满足跨境与本地合规要求。

#### 4.5.6 管理后台与运维
- 供应商管理：新增/禁用厂商、配置密钥与模型、查看健康与限额。
- 模型目录：统一展示 `provider/model`、能力、价格与SLA，支持搜索与筛选。
- 调用监控：QPS、延迟、错误率、成本统计；模型效果监控（采纳率/反馈）。
- A/B与评估：在线对比不同模型的质量与性能，支持灰度发布。

#### 4.5.7 后端API设计（与路由中心/Registry对齐）
- `GET /api/v1/llm/providers`：列出已注册的厂商与状态。
- `GET /api/v1/llm/models`：列出可用模型与能力、限额、成本。
- `POST /api/v1/llm/chat`：统一聊天接口，支持 `providerHint/modelId/stream`。
- `POST /api/v1/llm/embeddings`：生成嵌入，供向量库入库。
- `POST /api/v1/llm/moderate`：内容安全审核。
- `POST /api/v1/llm/eval`：质量评估与基准测试（离线/在线）。
- 所有API在注册时写入 `Registry`，前端自动展示与表单自动填充。

#### 4.5.8 典型调用流程
1) 前端提交 `/llm/chat`（可带 `providerHint`）→ 后端路由选择厂商与模型。
2) 后端以流式返回 → 前端展示与持久化会话。
3) 同步生成 `embeddings` → 写入向量库以便检索与上下文增强。
4) 记录调用指标与成本 → 供评估与路由策略优化。

#### 4.5.9 性能与扩展性
- 连接池与并发控制：按厂商API限制设置并发与队列；支持批处理调用。
- 重试与退避：幂等与指数退避；对可恢复错误自动重试。
- 缓存：对提示模板、静态响应与短期结果进行TTL缓存；支持结果去重。
- 指标与追踪：全链路追踪（traceId）、结构化日志、指标上报与告警。

#### 4.5.10 上线与合规流程
- 测试与灰度：接入前进行兼容性与负载测试，按用户群灰度发布。
- 秘钥管理与审计：密钥审批、操作审计与异常告警。
- 文档与演练：故障切换演练、供应商异常处置SOP、退回策略。

#### 4.5.11 配置与密钥管理（示例）
- 环境变量/配置中心：
  - `LLM_ENABLED_PROVIDERS="baidu,ali,tencent,iflytek,byte,zhipu,minimax"`
  - `LLM_PROVIDER_<ID>_API_BASE`、`LLM_PROVIDER_<ID>_API_KEY`、`LLM_PROVIDER_<ID>_MODELS`
  - `LLM_ROUTER_STRATEGY="latency_weighted|cost_aware|quality_first"`
  - `LLM_TIMEOUT_MS=15000`、`LLM_MAX_TOKENS=4096`、`LLM_MAX_QPS_PER_PROVIDER`
  - `LLM_COMPLIANCE_MODE="strict|standard"`（影响审核与过滤策略）
- 密钥存储：专用 Key Vault（加密、轮换、最小权限访问），操作留痕与告警。

#### 4.5.12 统一请求/响应规范
- 请求（简化）：
  - Chat：`{ modelId, messages:[{role, content}], stream?:true, temperature?, top_p?, providerHint? }`
  - Embeddings：`{ modelId, inputs:[text|string[]], modality:"text|audio|image" }`
  - Moderate：`{ content, categories? }`
- 响应：
  - Chat：`{ id, modelId, usage:{prompt, completion}, choices:[{role, content}] }`；流式以SSE/WebSocket返回 `token`。
  - Embeddings：`{ modelId, vectors:[float[]], dims }`
  - 错误：`{ code, message, providerCode?, retryable? }`

#### 4.5.13 错误码与重试策略
- 错误码映射：超时、配额、鉴权、输入非法、服务不可用统一到 `LLM_xxx` 前缀。
- 重试：对 `retryable` 错误指数退避，最大次数可配置；不可重试直接切换备选模型。
- 熔断：连续错误触发熔断窗口，进入降级路径（摘要/缓存/提示）。

#### 4.5.14 与向量库联动
- 自动生成嵌入：聊天完成后调用 `/llm/embeddings` → 写入向量库集合（按模块分集合）。
- 去重与压缩：对近似重复内容进行去重；大规模时使用 `IVF-PQ` 压缩提升存储效率。
- 召回增强：检索时先基于向量召回，再结合关键词与权限过滤进行重排。

#### 4.5.15 管理后台页面（新增）
- 厂商与模型目录：
  - 列表页：`provider/model`、能力、价格、SLA、健康度、配额与当前路由权重。
  - 详情页：示例请求、参数映射、限流与重试策略、近期调用指标。
- 配置管理：启用/禁用厂商、更新密钥与模型、设置路由策略与合规模式。
- 监控与评估：实时指标、告警列表、A/B结果与反馈采纳率。

#### 4.5.16 上线检查清单
- 功能：统一接口联调通过；流式与非流式兼容；嵌入向量入库成功。
- 性能：延迟与成功率达标；并发与QPS受控；熔断与降级可用。
- 安全：密钥加密存储与最小权限；内容合规过滤生效；审计日志完整。
- 文档：API在 `/api/registry` 与 Swagger 同步；SOP与异常处置文档齐备。

### 4.6 支付与结算闭环方案

#### 4.6.1 目标与原则
- 闭环：订单→支付→回调→入账→配额/点数变更→账单→对账→退款/申诉→归档。
- 安全：TLS、AES-256 字段级加密（PII/支付标识）、KMS 密钥轮换、全量审计。
- 合规：发票与税务合规、异常订单处置 SOP、用户权益保障与申诉通道。

#### 4.6.2 核心流程
1) 下单：创建订单，冻结待支付态；生成 `traceId` 便于追踪。
2) 拉起支付：调用第三方支付网关（抽象 `PaymentGateway`），返回重定向或二维码。
3) 回调入账：验签→幂等更新订单状态→支付成功落库，失败记录原因与可重试性。
4) 配额/点数：支付成功后变更算力点数或套餐权益，写入用量与账单。
5) 发票：用户申请→抬头/税号审核→开票生成与归档。
6) 对账结算：按周期拉取渠道账单→比对内部订单/用量→差异处理→生成结算单。
7) 退款售后：规则校验→退回权益→回滚点数→同步渠道退款结果。
8) 审计归档：订单/支付/退款/发票操作留痕，生成审计与合规报表。

#### 4.6.3 数据模型与安全
- Order：`id、userId、items[]、amount、currency、status、payChannel、traceId、createdAt、updatedAt`。
- Payment：`orderId、provider、tradeNo、status、paidAt、signature、retryable`。
- Invoice：`orderId、title、taxNo、amount、status、fileUrl、issuedAt`。
- Usage：`userId、quotaType、used、remaining、periodStart、periodEnd`。
- 加密：支付标识、税号等采用字段级加密（Envelope），密钥由 Key Vault/KMS 管理，最小权限访问与定期轮换。
- 审计：订单/支付/退款/发票操作事件写入审计日志，保留≥1年，支持追踪与抽样核查。

#### 4.6.4 后端 API 设计（与路由中心/Registry 对齐）
- `POST /api/v1/billing/orders`：创建订单（返回订单与支付引导信息）。
- `POST /api/v1/billing/pay`：拉起支付（二维码/跳转链接），支持多渠道。
- `POST /api/v1/billing/callback/:provider`：支付回调（幂等，验签处理）。
- `POST /api/v1/billing/refund`：申请退款（规则校验与可重试策略）。
- `GET /api/v1/billing/invoices`、`POST /api/v1/billing/invoices`：发票查询与申请。
- `GET /api/v1/billing/reconcile`：生成与下载对账报告。
- `GET /api/v1/billing/usage`：查询用量与账单（聚合周期、明细与摘要）。
- `GET /api/v1/billing/quotas`、`POST /api/v1/billing/quotas/adjust`：配额与点数调整（管理员权限）。
- 所有 API 注册到 Registry，声明 `requiredPermissions` 与 `request/response schema`，前端自动展示与表单填充。

#### 4.6.5 风控策略
- 设备/IP 画像、异常金额/频次阈值、黑白名单与拉黑策略。
- 支付前后与内容/账号风控联动；可疑订单进入人工复核。
- 降级：配额超限/欠费时禁用高成本模型或限流，提示充值与联系客服。

#### 4.6.6 算力与配额
- 点数扣减：`/llm/chat`、`/llm/embeddings`、`/ml/predict` 按模型成本与时长扣减；支持不同套餐权重。
- 预警与通知：剩余点数阈值提醒（站内信/邮件），支持自动续费开关与停用策略。
- 账单周期：月/季周期聚合，用量报表输出至管理后台；支持导出与对比。

#### 4.6.7 对账与发票
- 对账来源：支付网关账单、内部订单、配额变更、发票记录。
- 差异处理：重试拉单、人工复核、差异调整与审计记录。
- 发票合规：抬头与税号校验、电子发票归档与敏感信息加密存储。

#### 4.6.8 运维与 SOP
- 回调幂等与重试策略、异常告警、脏数据修复与校正流程。
- 审计抽样与合规稽核报表；季度容灾与密钥泄露演练。

### 4.7 AI 智能生成前端框架

#### 4.7.1 目标与原则
- 低门槛高标准：以自然语言/结构化需求生成生产级前端代码。
- 可控与可回滚：生成前预览与差异比对，审批后合并，支持回滚。
- 统一：与 `route-config`、`/api/registry`、权限系统和设计规范深度集成，跨 Web/移动端一致。

#### 4.7.2 架构组件
- Prompt-to-UI 引擎：将需求转为 UI DSL（`PageSpec/FormSpec/ListSpec` 基于 JSON Schema）。
- 组件库映射层：定义组件库（React/Ant Design/React Native）与属性映射，支持版本与主题。
- 路由与权限绑定：自动生成/更新 `route-config`，对齐接口 `requiredPermissions`。
- 数据绑定与校验：读取 `/api/registry` 的 `requestSchema/responseSchema`，生成类型安全的表单与数据视图。
- Codegen 管道：解析→规划→脚手架→代码填充→lint/format→预览快照→审批→合并。
- 设计规范：Design Tokens、响应式/可访问性（a11y）与国际化（i18n）约束。
- 守护与回滚：差异可视化、影响分析与快速回滚；生成过程留痕与审计。

#### 4.7.3 核心 API（与路由中心/Registry 对齐）
- `POST /api/v1/ai/frontend/generate`：输入需求/DSL/目标端（web|mobile）、组件库，返回生成快照ID与预览地址。
- `POST /api/v1/ai/frontend/validate`：校验 DSL 与数据绑定，输出问题清单与修复建议。
- `GET /api/v1/ai/frontend/templates`：列出模板库（页面/表单/列表/详情），支持继承与变体。
- `POST /api/v1/ai/frontend/commit`：经审批后将快照合并至主工程，写入审计。

#### 4.7.4 典型流程
1) 需求输入（自然语言/结构化）→ 提炼为 DSL 与页面结构。
2) 组件映射与数据绑定 → 生成类型安全代码与 `route-config` 更新。
3) 预览与联调 → 差异比对与问题修复 → 审批合并 → 生成文档。

#### 4.7.5 安全与合规
- PII 表单字段红线校验与掩码显示；敏感数据最小化传递。
- 生成过程与合并操作全量审计；权限校验与审批流集成。
- 预览环境隔离与密钥保护，禁用生产凭据与真实用户数据。

#### 4.7.6 管理后台
- 生成任务列表与状态、快照预览与差异、审批/回滚操作。
- 模板库管理、设计规范与 Design Tokens 配置、组件库版本管理。

### 4.8 AI 智能生成后端框架

#### 4.8.1 目标与原则
- 以需求/接口草案生成符合分层与安全规范的 Golang 服务代码。
- 强约束与可测试：接口/模型/仓储/中间件/测试全套脚手架，自动生成 Swagger 与 Registry 元数据。

#### 4.8.2 架构组件
- Prompt-to-API 引擎：需求→OpenAPI→领域模型→`Gin` Handler/Service/Repo 脚手架。
- 模板库：统一的服务/仓储/中间件（鉴权、限流、审计、错误处理）与测试模板。
- 质量护栏：静态分析与依赖审查、输入校验（JSON Schema/validator）、权限策略声明与强制绑定。
- 编排与CI：生成→lint/vet/test→Swagger/Registry 更新→预发布环境联调。
- 安全集成：字段级加密接口、审计事件、速率限制与熔断、幂等与重试策略。

#### 4.8.3 核心 API
- `POST /api/v1/ai/backend/generate`：输入需求/接口草案，返回工程变更快照与生成报告。
- `POST /api/v1/ai/backend/scaffold`：按模块生成脚手架（Handler/Service/Repo/Middleware/Tests）。
- `POST /api/v1/ai/backend/fix`：基于错误报告生成补丁建议（含代码 diff 与风险评估）。
- `GET /api/v1/ai/backend/templates`：列出后端模板与中间件清单。

#### 4.8.4 典型流程
1) 需求→OpenAPI→脚手架生成→实现与注释→单元与集成测试。
2) Swagger 与 `/api/registry` 同步 → RBAC 权限声明 → 预发联调 → 灰度发布。

#### 4.8.5 安全与合规
- 字段级加密与 KMS 集成、审计与最小权限访问、输入校验与反注入防护。
- 统一错误码与恢复策略、速率限制与熔断、日志脱敏与合规保留。

#### 4.8.6 管理后台
- 生成任务与报告、模板选择、风险评估与审批、自动生成的文档与测试覆盖率视图。

### 4.9 AI 智能联调与自动错误处理框架

#### 4.9.1 目标与原则
- 自动完成前后端联调与契约测试，分类诊断并提出可执行修复方案。
- 面向SLO：以错误预算与延迟目标驱动自动化修复与降级。

#### 4.9.2 架构组件
- 契约测试器：比对前端 DSL 与后端 OpenAPI/Registry，检测参数/类型/权限/版本差异。
- 测试数据生成器：合成/匿名数据，支持边界与异常场景，保护隐私与合规。
- 错误分类与自修复：网络/鉴权/限流/模式不匹配/后端异常分类；给出代码补丁与降级建议（缓存/重试/回退页面）。
- 运行时保护：幂等与重试、指数退避、熔断与隔离、全链路追踪与结构化日志、错误快照。
- 评估与仪表：联调通过率、延迟分布、错误预算、问题根因图谱与时间线。

#### 4.9.3 核心 API
- `POST /api/v1/ai/integration/test`：对指定页面/接口执行联调与契约测试，输出报告。
- `POST /api/v1/ai/integration/diagnose`：基于日志与快照进行根因分析与修复建议生成。
- `POST /api/v1/ai/integration/patch`：生成前后端代码补丁（diff）与风险提示，支持审批与回滚。
- `GET /api/v1/ai/integration/reports`：查看历次联调与修复报告。

#### 4.9.4 典型流程
1) 生成完成→联调测试→诊断与修复建议→预览与回归→审批合并。
2) 上线后持续监控→错误预算报警→自动降级/熔断→问题复盘与模板优化。

#### 4.9.5 安全与合规
- 联调环境隔离与密钥保护、数据匿名与最小化、审计留痕与审批机制。
- 错误日志脱敏与保留策略、合规模块与黑白名单策略联动。

#### 4.9.6 管理后台
- 联调任务与报告视图、错误分类仪表板、补丁建议与审批、自动化回归与SLO看板。

### 4.10 AI 生成/联调的 CI/CD 与审批流

#### 4.10.1 目标与原则
- 强门禁、强审计：所有AI生成与联调变更经门禁与审批后进入灰度，支持自动回滚。
- 环境隔离：预览/预发/生产严格隔离；敏感数据与密钥不泄露。

#### 4.10.2 流水线与门禁
- 生成快照：保存代码与配置变更快照、依赖与风险画像（traceId）。
- 语义/安全扫描：Prompt与DSL安全校验、Secrets扫描、依赖白名单与SBOM生成。
- 契约测试：比对 OpenAPI/Registry 与前端 DSL；参数/类型/权限/版本一致性校验。
- 预览环境：自动部署快照到隔离环境，提供预览URL与差异比对。
- 审批合并：双人双锁审批；合规/安全角色参与；审计留痕。
- 灰度发布：按用户/租户/百分比灰度，监控指标达标后全量；异常自动回滚。
- 变更记录：合并与回滚均生成审计事件与风险报告。

#### 4.10.3 CI 任务清单
- 代码质量：`lint/vet/test`、覆盖率与变更影响分析。
- 文档一致性：`swagger.json` 校验、`/api/registry` diff 与破坏性变更报告。
- 安全与合规：Secrets扫描、依赖许可证检查、提示词合规过滤（内容审查）。
- 性能门禁：关键接口延迟与错误率基线比较、错误预算占用评估。

#### 4.10.4 成本与配额守护
- LLM调用成本限制与预算曲线；高成本模型需额外审批。
- 生成与联调任务限流与配额管理，防止资源挤兑与成本失控。

#### 4.10.5 管理后台与报告
- 生成/联调流水线状态、预览链接、门禁结果、审批记录、灰度与回滚历史。

### 4.11 质量度量与指标体系

#### 4.11.1 指标
- 生成接受率（经审批合并占比）、契约通过率、联调一次通过率。
- 缺陷密度与回归率、覆盖率、变更引入的性能影响（P50/P99）。
- 错误预算消耗、自动修复成功率、平均恢复时间（MTTR）。

#### 4.11.2 SLO 与告警
- SLO：契约通过率≥95%、关键接口P99≤300ms、错误预算月度≤20%。
- 告警：联调失败与SLO超标、成本超预算与配额异常、回滚触发与失败重试。

#### 4.11.3 仪表与复盘
- 仪表板：质量/性能/成本/合规四象限；问题根因拓扑与时间线。
- 复盘：重大事件生成SOP改进建议与模板优化，纳入模板库版本管理。

### 4.12 风险与限流策略

#### 4.12.1 生成与联调限流
- 按用户/租户/项目维度限流与队列；高风险变更（路由/权限/支付）需单独审批。
- 测试模式：使用去标识化数据与模型的确定性/低成本路由；禁止生产密钥。

#### 4.12.2 风险缓解
- 缓存与降级：生成失败或成本超限时用缓存/低保真模板；前端提供降级页面。
- 隔离与熔断：单模块异常不影响全局；联调失败进入隔离沙箱并限流。

### 4.13 Prompt 治理与模板版本管理

#### 4.13.1 Prompt 库与规范
- Prompt库：系统提示、角色设定、风格与组件映射规则；版本化与变更审计。
- 规范：避免泄露密钥/PII；遵循内容合规；提示词质量评估与A/B。

#### 4.13.2 模板版本
- 模板（前端/后端/联调）统一版本管理；灰度试运行与效果追踪；回滚与停用策略。

#### 4.13.3 与向量库联动
- Prompt与模板嵌入入库，支持语义检索与复用；模板相似度与重复治理。

### 4.14 人机协作与审批分层

#### 4.14.1 角色与职责（RACI）
- 生成者（AI/开发）：产出DSL/代码/配置与变更快照；附风险说明。
- 审核者（Tech Lead）：语义正确性、架构一致性与性能影响评审。
- 合规与安全：内容合规、PII/Secrets、依赖许可证与安全扫描门禁。
- 发布负责人（Ops）：灰度策略与回滚演练、SLO守护与告警动作。

#### 4.14.2 审批分层
- 普通变更（UI/文案/样式）：单人审核+自动门禁。
- 中级变更（接口/数据结构）：双人双锁+契约测试必过。
- 高风险变更（权限/路由/支付/删除）：三方审批（TL/安全/合规）+预发演练。

#### 4.14.3 紧急流程
- 触发条件：生产事故或错误预算临界；进入紧急工单。
- 保护：限定范围灰度、强审计、自动回滚与事后复盘必选。

### 4.15 统一错误处理与错误码策略

#### 4.15.1 错误分类
- 客户端：校验错误、鉴权失败、权限不足、限流与配额、支付失败。
- 服务端：依赖超时、上游返回异常、内部错误、数据不一致。
- 联调：契约不一致、版本不兼容、字段缺失或类型不匹配。

#### 4.15.2 统一响应结构
- 字段：`code`、`message`、`detail`、`requestId`、`traceId`、`hint`、`severity`。
- 规范：面向用户的友好文案与面向开发的诊断信息分离；日志脱敏。

#### 4.15.3 自动错误处理策略
- 重试与退避：对超时/瞬时错误按指数退避；对幂等接口支持安全重试。
- 熔断与隔离：对持续失败的上游进行熔断；联调失败进入沙箱隔离。
- 补丁建议：结合错误分类生成代码/DSL差异补丁与测试；需审批后执行。
- 观测与定位：贯穿 `traceId` 与 `requestId`，联动日志与分布式追踪。

### 4.16 可观测性与端到端追踪

#### 4.16.1 追踪上下文
- 生成→联调→预览→灰度→生产全链路统一 `traceId`；跨服务传递与采样。
- 关键事件：门禁结果、审批记录、回滚操作、成本超限与配额变化。

#### 4.16.2 指标采集
- 合同通过率、错误分类占比、自动修复成功率、MTTR/MTBF；聚合到质量看板。


## 5. 项目实施计划

## 5. 项目实施计划

### 5.1 开发阶段划分
1. **MVP阶段** (1-2个月)：核心聊天功能 + 星座/周易基础测算
2. **功能完善阶段** (2-3个月)：完整测算服务 + 粉丝标签体系
3. **优化迭代阶段** (持续)：数据分析功能 + AI辅助功能

### 5.2 关键里程碑
* M1：产品原型设计完成 (2周)
* M2：MVP版本内部测试 (8周)
* M3：正式版上线 (16周)
* M4：数据分析模块上线 (24周)

### 5.3 AI 生成与联调实施路线图
* M5：前端生成框架 MVP（DSL/组件映射/预览与审批）
* M6：后端生成框架 MVP（Prompt-to-API/脚手架/测试与Swagger）
* M7：智能联调与自动错误处理 MVP（契约测试/错误分类/补丁建议）
* M8：CI/CD 门禁与灰度发布上线（Secrets/依赖/性能门禁、自动回滚）
* M9：质量度量与SLO看板上线，纳入季度迭代与模板治理

## 10. 附录

## 6. 商业模式

### 6.1 盈利方式
1. **订阅制**：主播按套餐付费使用高级功能
2. **增值服务**：单次高级测算服务分成
3. **广告收入**：精准投放与命理相关的产品广告
4. **API接口服务**：向第三方直播平台提供接口服务

### 6.2 定价策略
* 基础版：免费 (核心聊天功能 + 基础测算)
* 专业版：99元/月 (完整功能 + 数据分析)
* 企业版：599元/月 (多主播管理 + 定制化功能)
* 算力计算 测算点数

### 6.3 商业效果评估
* 实时订阅转化漏斗分析
* 各服务使用频率与付费转化率关联分析
* A/B测试框架支持定价策略优化
* 客户生命周期价值(CLV)追踪系统

## 7. 非功能需求

### 7.1 性能要求
* 系统响应时间：页面加载≤2秒，测算结果生成≤3秒
* 并发处理能力：支持1000+主播同时在线，单主播房间10000+粉丝互动
* 数据存储：用户数据保存≥3年，聊天记录保存≥6个月

### 7.2 安全要求
* 用户认证：支持手机号+验证码/第三方登录，敏感操作二次验证
* 数据加密：用户个人信息、支付数据、命理信息全程加密存储与传输，采用AES-256加密算法
* 权限控制：基于RBAC模型的细粒度权限管理
* 防攻击措施：防SQL注入、XSS攻击、CSRF防护、DDoS防护、敏感操作日志审计

### 7.3 数据安全与隐私管理

#### 7.3.1 数据收集原则
* **最小必要原则**：仅收集提供服务所必需的用户信息，命理测算仅收集出生日期、性别等必要数据
* **明确告知同意**：收集前明确告知数据用途，获得用户主动授权同意
* **分级分类管理**：对普通信息与敏感命理信息实施分级保护，敏感信息加密存储

#### 7.3.2 数据使用规范
* **授权范围内使用**：用户数据仅用于提供命理测算服务，未经许可不得用于其他目的
* **数据去标识化**：用于数据分析的用户数据需进行去标识化处理，保护个人隐私
* **第三方共享限制**：禁止向第三方共享用户原始数据，确需共享时需进行脱敏处理并明确告知用户

#### 7.3.3 用户控制机制
* **数据访问权**：用户可随时查看自己的所有个人数据与测算记录
* **数据更正权**：支持用户修改个人基本信息与测算输入数据
* **数据删除权**：提供账户注销功能，注销后72小时内彻底删除用户所有数据
* **隐私设置中心**：允许用户自主控制数据收集范围与使用权限

#### 7.3.4 安全保障措施
* **全链路加密**：用户数据从传输到存储全程采用AES-256加密算法保护，传输层采用TLS 1.3协议加密
* **安全审计机制**：建立数据操作日志，记录所有敏感数据访问行为，日志保留至少1年，支持审计追踪与异常行为分析
* **定期安全评估**：每季度进行数据安全风险评估与漏洞扫描，每半年进行一次渗透测试，每年进行一次安全架构评审
* **应急响应预案**：制定数据泄露应急处理流程，确保发生安全事件时可快速响应

#### 7.3.5 合规性要求
* 符合《网络安全法》《个人信息保护法》等相关法律法规要求，满足ISO 27001信息安全管理体系标准
* 定期进行隐私政策更新与用户告知，建立安全合规管理体系，通过第三方安全认证
* 建立用户申诉处理机制，48小时内响应隐私相关投诉

#### 7.3.6 数据生命周期与删除传播细则
- 范围：应用库（MySQL/Mongo）、缓存（Redis）、日志与对象存储、向量库与索引、训练集与备份。
- 时限：账户注销后72小时完成删除；失败自动重试并触发人工兜底；生成稽核报告。
- 传播：删除事件驱动执行向量集合删除与索引重建、清除缓存与会话、剔除训练样本与备份；对下游派生数据进行不可逆脱敏或删除。
- 校验：抽样核查与哈希校验；敏感数据不可逆脱敏确认；合规存证与追踪。

#### 7.3.7 静态加密与 KMS 策略
- 范围：数据库 TDE/磁盘加密、对象存储与备份加密、日志敏感字段屏蔽与脱敏。
- 密钥管理：Key Vault/KMS 分级密钥管理，季度/半年轮换；最小权限访问与审批留痕、异常告警。
- 演练：密钥泄露模拟与恢复 SOP；备份加密恢复演练与周期一致性校验。
- 访问：运营只读审计访问、研发使用脱敏数据集；重保期策略加强与双人双锁机制。

### 7.4 兼容性要求
* 移动端：支持iOS 12.0+、Android 8.0+系统
* Web端：兼容Chrome、Firefox、Safari、Edge最新版浏览器
* 屏幕适配：支持手机、平板、PC多终端自适应显示

## 8. 用户故事与用例

### 8.1 核心用户故事
1. 作为主播，我希望能给粉丝打标签，以便进行精准互动
2. 作为粉丝，我希望快速获取个人运势报告，以便了解今日运势
3. 作为主播，我希望系统能自动生成直播脚本，以提高准备效率

### 8.2 关键用例
* UC-001：粉丝命理测算流程
* UC-002：直播脚本创建与执行
* UC-003：粉丝标签管理与精准营销

## 9. 数据模型设计

### 9.1 核心实体
* 用户（User）：主播/粉丝基本信息
* 粉丝档案（FanProfile）：粉丝详细资料与标签
* 测算记录（FortuneRecord）：命理测算历史数据
* 直播脚本（LiveScript）：直播内容与流程设计
* 工作流（Workflow）：自动化流程定义与执行记录

## 10. 附录

### 10.1 术语表
* FIM：粉丝互动管理（Fan Interaction Management）
* FMS：命理测算服务（Fortune-telling Measurement Service）
* AW：主播工作台（Anchor Workbench）
* LCM：直播内容管理（Live Content Management）
* IWE：智能工作流引擎（Intelligent Workflow Engine）

### 10.2 参考资料
* 《命理服务行业规范》
* 《直播平台数据安全指南》
* 《用户隐私保护实施细则》

### 10.4 前端 DSL 示例（简化）
```
{
  "type": "PageSpec",
  "route": "/billing/invoices",
  "permissions": ["billing.view"],
  "components": [
    { "type": "List", "dataSource": { "api": "/api/v1/billing/invoices" },
      "columns": ["orderId", "title", "amount", "status", "issuedAt"] }
  ],
  "actions": [
    { "type": "Form", "title": "申请发票",
      "request": { "api": "/api/v1/billing/invoices", "method": "POST" },
      "schemaRef": "/api/registry#billing.invoice.requestSchema" }
  ]
}
```

### 10.5 OpenAPI 示例片段（简化）
```
paths:
  /api/v1/billing/orders:
    post:
      summary: Create order
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
```

### 10.6 契约测试报告示例摘要
- 差异：`/api/v1/billing/invoices` 响应字段 `issuedAt` 类型不一致（string vs number）。
- 诊断：后端OpenAPI定义为 `string(date-time)`；前端DSL期望 `number`。
- 修复建议：更新前端类型映射，或后端响应一致化；生成补丁与回归测试。

### 10.7 统一错误码规范（示例）
- 结构：`code`（字符串/可读分类）、`httpStatus`、`message`、`hint`、`severity`。
- 客户端错误（4xx）：
  - `E1000` ValidationError（参数/模式校验失败）
  - `E1100` AuthFailed（鉴权失败）
  - `E1200` PermissionDenied（权限不足）
  - `E1300` RateLimited（限流触发）
  - `E1400` QuotaExceeded（配额不足）
  - `E1500` PaymentRequired（支付/计费异常）
- 服务端错误（5xx）：
  - `E2000` UpstreamTimeout（上游超时）
  - `E2100` UpstreamBadResponse（上游响应异常）
  - `E3000` InternalError（内部错误）
  - `E3100` DataInconsistency（数据不一致）
- 重试策略映射：
  - `E2000/E2100`：指数退避重试，最多3次。
  - `E1300/E1400`：不重试，提示稍后重试或申请配额。
  - `E1500`：不重试，提示检查支付方式或联系客服。
  - `E1000/E1200`：不重试，提示修正参数或权限申请。

### 10.8 联调报告模板（简化）
- 背景：需求与范围、相关变更快照ID、版本信息。
- 目标接口：OpenAPI路径与版本、权限/配额要求。
- 前端DSL：路由、组件、数据源、权限绑定。
- 差异与错误：字段/类型/状态码/权限差异；错误分类与示例。
- 根因分析：架构/实现/配置/环境层面。
- 补丁建议：代码/DSL差异；测试用例与门禁清单。
- 审批与门禁：审批人与结果、门禁报告链接、预览URL。
- 风险与回滚：风险评估、灰度策略、回滚演练记录。

### 10.3 向量库安全附录
- 集合分级：按业务与敏感度分集合；限制 payload 字段白名单，避免存储 PII。
- 索引与加密：磁盘与备份加密、索引重建 SOP；大规模集合使用 `IVF-PQ` 时注意压缩与合规影响。
- 删除权：向量与 payload 删除的事件链路与验证；上下文增强的缓存清理与一致性校验。
- 访问控制：检索 API 附加权限过滤；跨租户隔离与全量审计记录。
- 备份与恢复：加密备份、周期校验与恢复演练；异常回滚策略与变更留痕。