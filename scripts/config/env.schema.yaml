# Environment schema for sanitized .env management
# Categories: runtime, auth, build, dedupe, db_runner, articles, sessions, audit

runtime:
  APP_ENV:
    type: enum
    enum: [dev, staging, prod]
    required: true
    default: dev
    example: staging
    description: Global runtime environment selector used by backend/config.
  PORT:
    type: int
    required: false
    default: 8080
    example: 9092
    description: HTTP server port.
  RATE_LIMIT_RPS:
    type: int
    required: false
    default: 10
    example: 100
    description: Requests per second per client IP.
  RATE_LIMIT_BURST:
    type: int
    required: false
    default: 20
    example: 100
    description: Token bucket burst size per client IP.

auth:
  AUTH_TOKENS:
    type: string
    required: false
    default: ''
    example: dev-token,masked-token-123
    description: Comma-separated bearer tokens (local/dev only). Use masked placeholders.
  JWT_SECRET:
    type: string
    required: false
    default: dev-secret
    example: ***
    description: HS256 signing secret for JWT (defaults to dev-secret). Provide masked placeholder if customized.

build:
  BUILD_VERSION:
    type: string
    required: false
    default: ''
    example: v0.1.0
    description: Build version injected by pipeline.
  GIT_SHA:
    type: string
    required: false
    default: ''
    example: abcdef0
    description: Short git commit hash injected by pipeline.
  BUILD_TIME:
    type: string
    required: false
    default: ''
    example: 2025-09-30T00:00:00Z
    description: UTC build time injected by pipeline.

dedupe:
  DEDUPER_BACKEND:
    type: enum
    enum: [memory, redis]
    required: false
    default: memory
    example: redis
    description: Backend for articles deduplication.
  REDIS_ADDR:
    type: string
    required: false
    default: ''
    example: masked-redis.example:6379
    description: Redis address.
  REDIS_PASSWORD:
    type: string
    required: false
    default: ''
    example: ***
    description: Redis password (use masked placeholder).
  REDIS_DB:
    type: int
    required: false
    default: 0
    example: 0
    description: Redis database index.
  ARTICLES_DEDUP_TTL_MS:
    type: int
    required: false
    default: 600000
    example: 600000
    description: TTL in ms for dedup keys.
  ARTICLES_DEDUP_KEY_PREFIX:
    type: string
    required: false
    default: 'articles:seen:'
    example: 'articles:seen:'
    description: Prefix for dedup keys.

db_runner:
  XZ_DB_TYPE:
    type: enum
    enum: [mysql, postgres]
    required: true
    default: mysql
    example: mysql
    description: Target DB type (current SQL uses MySQL dialect).
  XZ_DB_VERSION:
    type: string
    required: false
    default: 8.0.32
    example: 8.0.32
    description: Target DB engine version for compatibility notes.
  XZ_DB_TEST_DSN:
    type: string
    required: false
    default: ''
    example: 'mysql://user:***@test-db.example:3306/xingzuo_test?sslmode=required'
    description: Masked DSN for test environment.
  XZ_DB_STAGING_DSN:
    type: string
    required: false
    default: ''
    example: 'mysql://user:***@staging-db.example:3306/xingzuo_staging?sslmode=required'
    description: Masked DSN for staging environment.
  XZ_DB_PROD_DSN:
    type: string
    required: false
    default: ''
    example: 'mysql://user:***@prod-db.example:3306/xingzuo_prod?sslmode=required'
    description: Masked DSN for production environment.
  XZ_DB_OP_TIMEOUT:
    type: string
    required: false
    default: 30s
    example: 30s
    description: Per operation timeout (Go duration format).
  XZ_APPLY_DB:
    type: enum
    enum: [preview, dry-run, apply]
    required: false
    default: preview
    example: preview
    description: Operation mode for DB runner.
  XZ_APPROVED_TICKET:
    type: string
    required: false
    default: ''
    example: TICKET-12345
    description: Approval ticket ID required when applying changes.

articles:
  ARTICLES_HEARTBEAT_DEFAULT_MS:
    type: int
    required: false
    default: 0
    example: 5
    description: SSE heartbeat default interval (ms).
  ARTICLES_HEARTBEAT_MIN_MS:
    type: int
    required: false
    default: 0
    example: 1
    description: SSE heartbeat min interval (ms).
  ARTICLES_HEARTBEAT_MAX_MS:
    type: int
    required: false
    default: 0
    example: 1000
    description: SSE heartbeat max interval (ms).
  ARTICLES_LIST_PAGESIZE_DEFAULT:
    type: int
    required: false
    default: 0
    example: 20
    description: Default page size for listing articles.
  ARTICLES_LIST_PAGESIZE_MIN:
    type: int
    required: false
    default: 0
    example: 5
    description: Min page size.
  ARTICLES_LIST_PAGESIZE_MAX:
    type: int
    required: false
    default: 0
    example: 100
    description: Max page size.
  ARTICLES_FOLLOW_MAX_MS_DEFAULT:
    type: int
    required: false
    default: 0
    example: 200
    description: Follow max default (ms).
  ARTICLES_FOLLOW_MAX_MS_MIN:
    type: int
    required: false
    default: 0
    example: 100
    description: Follow max min (ms).
  ARTICLES_FOLLOW_MAX_MS_MAX:
    type: int
    required: false
    default: 0
    example: 500
    description: Follow max max (ms).
  ARTICLES_FOLLOW_BUFFER_MS_DEFAULT:
    type: int
    required: false
    default: 0
    example: 10
    description: Follow buffer default (ms).
  ARTICLES_FOLLOW_BATCH_MAX_DEFAULT:
    type: int
    required: false
    default: 0
    example: 50
    description: Follow batch max default.

sessions:
  SESSION_BACKEND:
    type: enum
    enum: [memory, redis]
    required: false
    default: memory
    example: redis
    description: Backend for fan session uniqueness (active conversation) persistence.
  SESSION_ACTIVE_TTL_MS:
    type: int
    required: false
    default: 600000
    example: 600000
    description: TTL in ms for active session occupancy; auto-release on expiration.
  SESSION_KEY_PREFIX:
    type: string
    required: false
    default: 'sessions:active:'
    example: 'sessions:active:'
    description: Prefix for session keys in Redis namespace.

audit:
  AUDIT_FORWARD_ENABLE:
    type: enum
    enum: [true, false]
    required: false
    default: false
    example: false
    description: Enable forwarding audit events to /api/v1/observe/events.
  OBSERVE_ENDPOINT:
    type: string
    required: false
    default: ''
    example: 'http://127.0.0.1:8080/api/v1/observe/events'
    description: Observe endpoint for receiving audit events; defaults to local PORT when empty.
  OBSERVE_TOKEN:
    type: string
    required: false
    default: ''
    example: '***'
    description: Bearer token for forwarding when request context lacks auth_token.

backend_db:
  DB_DSN:
    type: string
    required: false
    default: ''
    example: 'user:***@tcp(127.0.0.1:3306)/xingzuo_dev?parseTime=true&multiStatements=true&charset=utf8mb4&collation=utf8mb4_unicode_ci'
    description: Preferred DSN for backend MySQL connection (internal/db). If empty, will be composed from component variables.
  DB_HOST:
    type: string
    required: false
    default: '127.0.0.1'
    example: 'db.example'
    description: MySQL host when DB_DSN is not provided.
  DB_PORT:
    type: int
    required: false
    default: 3306
    example: 3306
    description: MySQL port when DB_DSN is not provided.
  DB_USER:
    type: string
    required: false
    default: 'root'
    example: 'user'
    description: MySQL username when DB_DSN is not provided.
  DB_PASS:
    type: string
    required: false
    default: ''
    example: '***'
    description: MySQL password (masked). If empty, password flag is omitted in CLI scripts.
  DB_NAME:
    type: string
    required: false
    default: 'xingzuo_dev'
    example: 'xingzuo_dev'
    description: Target database name.
  DB_UNIX_SOCKET:
    type: string
    required: false
    default: ''
    example: '/var/run/mysqld/mysqld.sock'
    description: Optional MySQL unix socket path; when set, backend may prefer socket connection.